<!DOCTYPE HTML>
<html>
<head>
    <title>Study Plan - Studia</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="css/sidebar-fixed.css" />
    <link rel="stylesheet" href="css/dark-mode.css" />
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
    <style>
        /* Menu Toggle Button Styling - Modern Design */
        .menu-toggle-btn {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            background: #f56a6a;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(245, 106, 106, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            text-align: center;
            z-index: 10001;
            display: flex !important;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            visibility: visible !important;
            opacity: 1 !important;
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 0;
        }
        
        .menu-toggle-btn:hover {
            background: #f45858;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 106, 106, 0.4);
        }
        
        .menu-toggle-btn:active {
            transform: translateY(0);
        }
        
        /* Toggle button icon animation */
        .menu-toggle-btn i {
            transition: all 0.3s ease;
            width: 20px;
            height: 20px;
            position: relative;
            display: block;
        }
        
        .menu-toggle-btn i::before,
        .menu-toggle-btn i::after,
        .menu-toggle-btn span {
            content: '';
            position: absolute;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .menu-toggle-btn i::before {
            left: 0;
            top: -6px;
            width: 20px;
            height: 2px;
        }
        
        .menu-toggle-btn span {
            left: 0;
            top: 0;
            width: 20px;
            height: 2px;
        }
        
        .menu-toggle-btn i::after {
            left: 0;
            top: 6px;
            width: 20px;
            height: 2px;
        }
        
        /* Toggle button when sidebar is active */
        body:not(.sidebar-inactive) .menu-toggle-btn i::before {
            transform: rotate(45deg);
            top: 0;
        }
        
        body:not(.sidebar-inactive) .menu-toggle-btn span {
            opacity: 0;
        }
        
        body:not(.sidebar-inactive) .menu-toggle-btn i::after {
            transform: rotate(-45deg);
            top: 0;
        }
        
        .schedule-form-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
        }
        .schedule-form-container h3 {
            color: white;
            margin-bottom: 20px;
        }
        .schedule-form-container .form-group {
            margin-bottom: 20px;
        }
        .schedule-form-container label {
            display: block;
            margin-bottom: 5px;
            color: white;
        }
        .schedule-form-container input[type="text"],
        .schedule-form-container input[type="date"],
        .schedule-form-container input[type="time"],
        .schedule-form-container select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .schedule-form-container input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .schedule-form-container input[type="radio"],
        .schedule-form-container input[type="checkbox"] {
            margin-right: 5px;
        }
        .schedule-form-container .radio-group,
        .schedule-form-container .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .repeat-options {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .repeat-days {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .repeat-days label {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            cursor: pointer;
        }
        #calendar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .fc-event {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .fc-event-class {
            background: #667eea;
            border-color: #667eea;
        }
        .fc-event-exam {
            background: #f56a6a;
            border-color: #f56a6a;
        }
        .fc-event-study {
            background: #4caf50;
            border-color: #4caf50;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .view-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .event-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .event-modal-content {
            position: relative;
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 500px;
            border-radius: 15px;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #f56a6a;
        }
        
        /* TODO Styles */
        .todo-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }
        .todo-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .todo-text {
            flex: 1;
            font-size: 1em;
            color: #333;
        }
        .todo-text.completed {
            text-decoration: line-through;
            color: #999;
        }
        .todo-date {
            font-size: 0.85em;
            color: #666;
        }
        .todo-actions {
            display: flex;
            gap: 10px;
        }
        .todo-edit-btn, .todo-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .todo-edit-btn:hover {
            background: #e3f2fd;
            color: #2196f3;
        }
        .todo-delete-btn:hover {
            background: #ffebee;
            color: #f44336;
        }
        .todo-priority {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .priority-high {
            background: #ffebee;
            color: #f44336;
        }
        .priority-medium {
            background: #fff4e5;
            color: #ff9800;
        }
        .priority-low {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        /* Radio button styles */
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        .radio-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .radio-option input[type="radio"] {
            display: none;
        }
        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s;
        }
        .radio-option input[type="radio"]:checked + .radio-custom {
            border-color: white;
            background: white;
        }
        .radio-option input[type="radio"]:checked + .radio-custom:after {
            content: '';
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Checkbox styles for days */
        .day-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }
        .day-checkbox:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .day-checkbox input[type="checkbox"] {
            display: none;
        }
        .day-checkbox input[type="checkbox"]:checked + span {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        .day-checkbox span {
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }
    </style>
</head>
<body class="is-preload">
    <!-- Menu Toggle Button -->
    <button class="menu-toggle-btn" onclick="toggleSidebar()">
        <i><span></span></i>
    </button>
    
    <!-- Wrapper -->
    <div id="wrapper">
        <!-- Main -->
        <div id="main">
            <div class="inner">
                <!-- Header -->
                <header id="header">
                    <a href="index.html" class="logo">
                        <strong style="font-size: 2em;">Studia</strong>
                    </a>
                    <ul class="icons">
                        <li><span id="userWelcome" style="margin-right: 1em;">Welcome!</span></li>
                        <li><a href="#" onclick="logout()" class="button small">Logout</a></li>
                    </ul>
                </header>

                <!-- Content -->
                <section>
                    <header class="main">
                        <h1>Study Plan</h1>
                        <p>Organize your schedule and let AI help you plan your study sessions</p>
                    </header>

                    <!-- Schedule Form -->
                    <div class="schedule-form-container">
                        <h3>Add New Schedule</h3>
                        <form id="schedule-form">
                            <div class="form-group">
                                <label>Type</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="type" value="class" checked onclick="handleTypeChange()">
                                        <span class="radio-custom"></span>
                                        <span>Class</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="type" value="exam" onclick="handleTypeChange()">
                                        <span class="radio-custom"></span>
                                        <span>Exam</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="type" value="study" onclick="handleTypeChange()">
                                        <span class="radio-custom"></span>
                                        <span>Study Session</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="className">Class Name (Optional)</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="classSelect" onchange="handleClassSelect()" style="flex: 1;">
                                        <option value="">-- Select existing class --</option>
                                        <option value="__new__">+ Add new class</option>
                                    </select>
                                    <input type="text" id="className" name="className" placeholder="Or enter new class name" style="flex: 1;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" id="title" name="title" placeholder="e.g., Data Structures Class" required>
                            </div>

                            <div class="form-group">
                                <label for="date" id="dateLabel">Start Date</label>
                                <input type="date" id="date" name="date" required>
                            </div>

                            <div class="form-group" id="allDayContainer" style="display: none;">
                                <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="allDay" name="allDay" onchange="toggleTimeInputs()" style="display: none;">
                                    <span class="checkbox-custom" style="width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.5); border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                                        <i class="fas fa-check" style="color: #667eea; font-size: 14px; opacity: 0; transition: opacity 0.3s;"></i>
                                    </span>
                                    All Day Event
                                </label>
                            </div>

                            <div class="form-group time-inputs" id="timeInputs">
                                <div>
                                    <label for="startTime">Start Time</label>
                                    <input type="time" id="startTime" name="startTime" required>
                                </div>
                                <div>
                                    <label for="endTime">End Time</label>
                                    <input type="time" id="endTime" name="endTime" required>
                                </div>
                            </div>

                            <div class="form-group" id="colorPicker">
                                <label for="color">Event Color</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                    <input type="color" id="colorInput" name="color" value="#667eea" style="width: 50px; height: 50px; border: none; border-radius: 8px; cursor: pointer;">
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #667eea; cursor: pointer;" onclick="setColor('#667eea')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #f56a6a; cursor: pointer;" onclick="setColor('#f56a6a')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #4caf50; cursor: pointer;" onclick="setColor('#4caf50')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #ff9800; cursor: pointer;" onclick="setColor('#ff9800')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #2196f3; cursor: pointer;" onclick="setColor('#2196f3')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #9c27b0; cursor: pointer;" onclick="setColor('#9c27b0')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #00bcd4; cursor: pointer;" onclick="setColor('#00bcd4')"></button>
                                        <button type="button" class="color-preset" style="width: 40px; height: 40px; border: none; border-radius: 8px; background: #795548; cursor: pointer;" onclick="setColor('#795548')"></button>
                                    </div>
                                </div>
                                <div id="recentColors" style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Recent Colors:</label>
                                    <div id="recentColorsList" style="display: flex; gap: 8px;"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="repeat" name="repeat" onchange="toggleRepeatOptions()">
                                    Repeat Event
                                </label>
                            </div>

                            <div class="repeat-options" id="repeatOptions">
                                <div class="form-group">
                                    <label for="repeatType">Repeat Type</label>
                                    <select id="repeatType" name="repeatType">
                                        <option value="weekly">Weekly</option>
                                        <option value="biweekly">Bi-weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>

                                <div class="form-group" id="weeklyDays" style="display: none;">
                                    <label>Days of Week</label>
                                    <div class="repeat-days">
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="1">
                                            <span>Mon</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="2">
                                            <span>Tue</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="3">
                                            <span>Wed</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="4">
                                            <span>Thu</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="5">
                                            <span>Fri</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="6">
                                            <span>Sat</span>
                                        </label>
                                        <label class="day-checkbox">
                                            <input type="checkbox" name="repeatDays" value="0">
                                            <span>Sun</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="repeatUntil">Repeat Until</label>
                                    <input type="date" id="repeatUntil" name="repeatUntil">
                                </div>
                            </div>

                            <button type="submit" class="button primary">Add to Schedule</button>
                        </form>
                    </div>

                    <!-- Filter and View Toggle -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Class:</label>
                                <select id="classFilterCalendar" onchange="filterCalendarByClass()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="view-toggle" style="flex: 2;">
                                <button class="active" onclick="changeView('month')">Month</button>
                                <button onclick="changeView('week')">Week</button>
                                <button onclick="changeView('day')">Day</button>
                                <button onclick="changeView('list')">List</button>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar -->
                    <div id="calendar"></div>

                    <!-- TODO List -->
                    <div class="box" style="margin-top: 30px;">
                        <h3>üìù Study TODO List</h3>
                        <div class="todo-container">
                            <div class="todo-input-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input type="text" id="todoInput" placeholder="Add a new study task..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <button class="button primary" onclick="addTodo()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="todoList">
                                <!-- TODOs will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- AI Study Plan -->
                    <div class="box">
                        <h3>AI Study Plan Generator</h3>
                        <p>Generate an optimized study plan based on your schedule</p>
                        <button class="button primary" onclick="generateAIStudyPlan()">
                            <i class="fas fa-magic"></i> Generate Study Plan
                        </button>
                        <div id="aiPlanResult" style="display: none; margin-top: 20px;"></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <div class="inner">
                <!-- Menu -->
                <nav id="menu">
                    <header class="major">
                        <h2>Menu</h2>
                    </header>
                    <ul>
                        <li><a href="index.html">Main</a></li>
                        <li><a href="summary.html">Summary</a></li>
                        <li><a href="quiz.html">Quiz</a></li>
                        <li><a href="plan.html">Study Plan</a></li>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="leaderboard.html">Leaderboard</a></li>
                        <li><a href="friends.html">Friends</a></li>
                        <li><a href="profile.html">My Page</a></li>
                    </ul>
                </nav>

                <!-- Footer -->
                <footer id="footer">
                    <p class="copyright">&copy; Studia. Design: <a href="http://html5up.net">HTML5 UP</a>.</p>
                </footer>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="event-modal">
        <div class="event-modal-content">
            <span class="modal-close" onclick="closeEventModal()">&times;</span>
            <h3 id="modalTitle">Event Details</h3>
            <div id="modalContent"></div>
            <div style="margin-top: 20px;">
                <button class="button primary" onclick="editEvent()">Edit</button>
                <button class="button" onclick="deleteEvent()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/jquery.min.js"></script>
    <script src="js/browser.min.js"></script>
    <script src="js/breakpoints.min.js"></script>
    <script src="js/util.js"></script>
    <script src="js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="js/sidebar-toggle.js"></script>
    <script src="js/dark-mode.js"></script>
    <script src="js/sidebar-state.js"></script>
    <script>
        // Toggle Sidebar Function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            const toggleBtn = document.querySelector('.menu-toggle-btn');
            
            sidebar.classList.toggle('inactive');
            
            if (sidebar.classList.contains('inactive')) {
                document.body.classList.add('sidebar-inactive');
            } else {
                document.body.classList.remove('sidebar-inactive');
            }
        }
        
        let calendar;
        let schedules = [];
        let todos = [];
        let currentEvent = null;
        let editingEventId = null;

        // Check authentication
        if (!checkAuth()) {
            window.location.href = 'index.html';
        }

        // Update welcome message
        document.getElementById('userWelcome').textContent = `Welcome, ${TokenManager.getUsername() || 'User'}!`;

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Study Plan page...');
            
            // Set initial sidebar state - always start closed
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.add('inactive');
                document.body.classList.add('sidebar-inactive');
            }
            
            try {
                // Initialize calendar first
                initializeCalendar();
                console.log('Calendar initialized');
                
                // Then load schedules
                await loadSchedules();
                console.log('Schedules loaded successfully');
                
                // Load TODOs
                loadTodos();
                console.log('TODOs loaded');
                
                // Update class filter options - get classes from both schedules and materials
                window.updateClassFilter = async function() {
                    const classFilter = document.getElementById('classFilterCalendar');
                    const classSelect = document.getElementById('classSelect');
                    
                    // Get classes from schedules
                    let scheduleClasses = [...new Set(schedules
                        .filter(s => s.className && s.className.trim())
                        .map(s => s.className))];
                    
                    // Also get classes from Study Plans where type is 'class'
                    let classTypeSchedules = [...new Set(schedules
                        .filter(s => s.type === 'class' && s.title)
                        .map(s => s.title))];
                    
                    // Get classes from materials (if available)
                    let materialClasses = [];
                    try {
                        const materials = await API.materials.list();
                        materialClasses = [...new Set(materials
                            .filter(m => m.className && m.className.trim())
                            .map(m => m.className))];
                    } catch (error) {
                        console.log('Could not fetch materials for class list:', error);
                    }
                    
                    // Combine all unique classes
                    const allClasses = [...new Set([...scheduleClasses, ...classTypeSchedules, ...materialClasses])];
                    console.log('All available classes:', allClasses);
                    
                    // Update calendar filter
                    if (classFilter) {
                        classFilter.innerHTML = '<option value="">All Classes</option>' +
                            allClasses.map(className => 
                                `<option value="${className}">${className}</option>`
                            ).join('');
                    }
                    
                    // Update form select
                    if (classSelect) {
                        classSelect.innerHTML = '<option value="">-- Select existing class --</option>' +
                            allClasses.map(className => 
                                `<option value="${className}">${className}</option>`
                            ).join('') +
                            '<option value="__new__">+ Add new class</option>';
                    }
                }
                
                // Initial update
                updateClassFilter();
                
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('Error loading study plan. Please refresh the page.');
            }
            
            // Handle class selection
            window.handleClassSelect = function() {
                const select = document.getElementById('classSelect');
                const input = document.getElementById('className');
                
                if (select.value === '__new__') {
                    input.value = '';
                    input.focus();
                    input.style.display = 'block';
                } else if (select.value) {
                    input.value = select.value;
                    input.style.display = 'none';
                } else {
                    input.value = '';
                    input.style.display = 'block';
                }
            }
            
            // Filter calendar by class
            window.filterCalendarByClass = function() {
                const selectedClass = document.getElementById('classFilterCalendar').value;
                
                if (calendar) {
                    calendar.removeAllEvents();
                    
                    let filteredEvents = getCalendarEvents();
                    if (selectedClass) {
                        filteredEvents = filteredEvents.filter(event => {
                            // Check both className and if it's a TODO
                            return event.extendedProps.className === selectedClass ||
                                   (selectedClass === 'TODO List' && event.extendedProps.isTodo);
                        });
                    }
                    
                    calendar.addEventSource(filteredEvents);
                }
            }
            
            // Add checkbox styling functionality
            const allDayCheckbox = document.getElementById('allDay');
            if (allDayCheckbox) {
                allDayCheckbox.addEventListener('change', function() {
                    const checkIcon = this.parentElement.querySelector('.fa-check');
                    if (this.checked) {
                        checkIcon.style.opacity = '1';
                        this.parentElement.querySelector('.checkbox-custom').style.background = 'white';
                    } else {
                        checkIcon.style.opacity = '0';
                        this.parentElement.querySelector('.checkbox-custom').style.background = 'transparent';
                    }
                });
            }
            
            // Add Enter key support for TODO input
            const todoInput = document.getElementById('todoInput');
            if (todoInput) {
                todoInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTodo();
                    }
                });
            }
            
            // Update recent colors
            updateRecentColors();
        });

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            if (!calendarEl) {
                console.error('Calendar element not found!');
                return;
            }
            
            try {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    editable: true,
                    droppable: true,
                    events: [], // Start with empty events
                    eventClick: function(info) {
                        showEventModal(info.event);
                    },
                    eventDrop: function(info) {
                        updateEventDateTime(info.event);
                    },
                    eventResize: function(info) {
                        updateEventDateTime(info.event);
                    },
                    height: 'auto',
                    views: {
                        timeGridWeek: {
                            allDaySlot: true
                        },
                        timeGridDay: {
                            allDaySlot: true
                        }
                    },
                    eventDidMount: function(info) {
                        // Add tooltip or other event customizations
                        console.log('Event mounted:', info.event.title);
                    }
                });
                calendar.render();
                console.log('Calendar rendered successfully');
            } catch (error) {
                console.error('Error initializing calendar:', error);
                // Show user-friendly error message
                calendarEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 10px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #f44336; margin-bottom: 20px;"></i>
                        <h3>Calendar loading error</h3>
                        <p>Please refresh the page or try again later.</p>
                        <button class="button primary" onclick="location.reload()">Refresh Page</button>
                    </div>
                `;
            }
        }

        function getCalendarEvents() {
            const events = schedules.map(schedule => {
                // Set default color based on type if not provided
                let defaultColor = '#667eea'; // default
                if (schedule.type === 'class') defaultColor = '#667eea';
                else if (schedule.type === 'exam') defaultColor = '#f56a6a';
                else if (schedule.type === 'study') defaultColor = '#4caf50';
                
                // Override with TODO colors if it's a TODO item
                if (schedule.isTodo) {
                    if (schedule.title.includes('TODO:')) {
                        const todo = todos.find(t => schedule.id === 'todo-' + t.id);
                        if (todo && todo.priority === 'high') defaultColor = '#f44336';
                        else if (todo && todo.priority === 'medium') defaultColor = '#ff9800';
                        else defaultColor = '#4caf50';
                    }
                }
                
                return {
                    id: schedule.id,
                    title: schedule.title,
                    start: schedule.allDay ? schedule.date : schedule.date + 'T' + schedule.startTime,
                    end: schedule.allDay ? null : schedule.date + 'T' + schedule.endTime,
                    allDay: schedule.allDay || false,
                    backgroundColor: schedule.color || defaultColor,
                    borderColor: schedule.color || defaultColor,
                    extendedProps: schedule
                };
            });
            
            console.log('Calendar events:', events);
            return events;
        }

        function handleTypeChange() {
            const selectedType = document.querySelector('input[name="type"]:checked').value;
            const dateLabel = document.getElementById('dateLabel');
            const allDayContainer = document.getElementById('allDayContainer');
            const repeatOptions = document.getElementById('repeat').parentElement;
            
            if (selectedType === 'class') {
                dateLabel.textContent = 'Start Date';
                allDayContainer.style.display = 'block';
                repeatOptions.style.display = 'block';
            } else {
                dateLabel.textContent = 'Date';
                allDayContainer.style.display = 'none';
                repeatOptions.style.display = 'block';
                document.getElementById('allDay').checked = false;
                toggleTimeInputs();
            }
        }

        function toggleTimeInputs() {
            const allDay = document.getElementById('allDay').checked;
            const timeInputs = document.getElementById('timeInputs');
            const startTime = document.getElementById('startTime');
            const endTime = document.getElementById('endTime');
            
            if (allDay) {
                timeInputs.style.display = 'none';
                startTime.removeAttribute('required');
                endTime.removeAttribute('required');
            } else {
                timeInputs.style.display = 'grid';
                startTime.setAttribute('required', 'required');
                endTime.setAttribute('required', 'required');
            }
        }

        async function loadSchedules() {
            try {
                console.log('Loading schedules from server...');
                // Î∞±ÏóîÎìúÏóêÏÑú Ïä§ÏºÄÏ§Ñ Î∂àÎü¨Ïò§Í∏∞
                const serverSchedules = await API.studyPlans.getAll();
                console.log('Loaded schedules from server:', serverSchedules);
                
                // ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                schedules = serverSchedules.map(plan => ({
                    id: plan.id.toString(),
                    type: plan.type || 'study',
                    title: plan.title,
                    date: plan.date,
                    startTime: plan.startTime || '00:00',
                    endTime: plan.endTime || '23:59',
                    allDay: plan.allDay || false,
                    color: plan.color || '#667eea',
                    repeat: plan.repeat || false,
                    repeatType: plan.repeatType || null,
                    repeatUntil: plan.repeatUntil || null,
                    repeatDays: plan.repeatDays || [],
                    className: plan.className || null,
                    description: plan.description || null
                }));
                
                console.log('Converted schedules:', schedules);
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏôÄ ÎèôÍ∏∞Ìôî (Î∞±ÏóÖÏö©)
                localStorage.setItem('studiaSchedules', JSON.stringify(schedules));
                
                // ÌÅ¥ÎûòÏä§ ÌïÑÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (window.updateClassFilter) {
                    updateClassFilter();
                }
                
                // Ï∫òÎ¶∞ÎçîÍ∞Ä Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïù¥Î≤§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                if (calendar) {
                    console.log('Updating calendar with new events');
                    calendar.removeAllEvents();
                    const events = getCalendarEvents();
                    console.log('Events to add to calendar:', events);
                    calendar.addEventSource(events);
                    calendar.render();
                }
                
            } catch (error) {
                console.error('Failed to load schedules from server:', error);
                console.log('Loading from local storage as fallback...');
                // ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®Ïãú Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
                const saved = localStorage.getItem('studiaSchedules');
                if (saved) {
                    schedules = JSON.parse(saved);
                    console.log('Loaded from local storage:', schedules);
                } else {
                    schedules = [];
                    console.log('No schedules found in local storage');
                }
                
                // ÌÅ¥ÎûòÏä§ ÌïÑÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (window.updateClassFilter) {
                    updateClassFilter();
                }
                
                // Ï∫òÎ¶∞ÎçîÍ∞Ä Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïù¥Î≤§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(getCalendarEvents());
                }
            }
        }

        async function saveSchedules() {
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ (Ï¶âÏãú Î∞òÏòÅ)
            localStorage.setItem('studiaSchedules', JSON.stringify(schedules));
            
            // Ï∫òÎ¶∞Îçî ÏóÖÎç∞Ïù¥Ìä∏
            if (calendar) {
                // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î™®Îëê Ï†úÍ±∞
                calendar.removeAllEvents();
                
                // ÏÉàÎ°úÏö¥ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                const events = getCalendarEvents();
                console.log('Updating calendar with events:', events.length);
                
                // addEventSource ÎåÄÏã† Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏó¨ Ï§ëÎ≥µ Î∞©ÏßÄ
                events.forEach(event => {
                    calendar.addEvent(event);
                });
            }
        }

        function toggleRepeatOptions() {
            const repeatOptions = document.getElementById('repeatOptions');
            const repeat = document.getElementById('repeat').checked;
            repeatOptions.style.display = repeat ? 'block' : 'none';
            
            if (repeat) {
                const repeatType = document.getElementById('repeatType');
                const weeklyDays = document.getElementById('weeklyDays');
                
                repeatType.addEventListener('change', function() {
                    weeklyDays.style.display = this.value === 'weekly' ? 'block' : 'none';
                });
                
                // Trigger initial state
                weeklyDays.style.display = repeatType.value === 'weekly' ? 'block' : 'none';
            }
        }

        document.getElementById('schedule-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const schedule = {
                id: editingEventId || Date.now().toString(),
                type: formData.get('type'),
                title: formData.get('title'),
                date: formData.get('date'),
                startTime: formData.get('startTime') || '00:00',
                endTime: formData.get('endTime') || '23:59',
                allDay: formData.get('allDay') === 'on',
                color: formData.get('color'),
                repeat: formData.get('repeat') === 'on'
            };

            // ÏÑúÎ≤ÑÏóê Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const classNameValue = formData.get('className') || null;
            const planRequest = {
                title: schedule.title,
                type: schedule.type,
                date: schedule.date,
                startTime: schedule.allDay ? null : schedule.startTime,
                endTime: schedule.allDay ? null : schedule.endTime,
                allDay: schedule.allDay,
                color: schedule.color,
                repeat: schedule.repeat,
                className: classNameValue, // classNameÏùÄ Î≥ÑÎèÑ ÌïÑÎìúÎ°ú Ï†ÄÏû•
                description: formData.get('description') || null
            };

            if (schedule.repeat) {
                planRequest.repeatType = formData.get('repeatType');
                planRequest.repeatUntil = formData.get('repeatUntil') || null;
                if (planRequest.repeatType === 'weekly') {
                    planRequest.repeatDays = Array.from(document.querySelectorAll('input[name="repeatDays"]:checked'))
                        .map(cb => parseInt(cb.value));
                }
            }

            try {
                console.log('Saving schedule:', editingEventId ? 'Update' : 'Create', planRequest);
                
                if (editingEventId) {
                    // Í∏∞Ï°¥ ÏùºÏ†ï ÏóÖÎç∞Ïù¥Ìä∏
                    const response = await API.studyPlans.update(editingEventId, planRequest);
                    console.log('Update response:', response);
                } else {
                    // ÏÉà ÏùºÏ†ï ÏÉùÏÑ±
                    const response = await API.studyPlans.create(planRequest);
                    console.log('Create response:', response);
                    if (response && response.id) {
                        schedule.id = response.id.toString();
                    }
                }
                
                // ÏÑ±Í≥µ Ïãú Î°úÏª¨ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ï∫òÎ¶∞Îçî ÏÉàÎ°úÍ≥†Ïπ®
                await loadSchedules();
                console.log('Schedule saved successfully');
                
                // Show success notification
                showNotification('Schedule saved successfully!');
                
            } catch (error) {
                console.error('Failed to save schedule:', error);
                console.error('Error details:', error.response || error.message);
                alert('ÏùºÏ†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏò§Î•ò: ' + (error.message || 'Unknown error'));
                return;
            }

            // Ìèº Ï¥àÍ∏∞Ìôî
            this.reset();
            editingEventId = null;
            document.getElementById('repeatOptions').style.display = 'none';
            document.getElementById('allDayContainer').style.display = 'none';
            document.getElementById('timeInputs').style.display = 'grid';
        });

        function generateRecurringEvents(baseSchedule) {
            const startDate = new Date(baseSchedule.date);
            const endDate = baseSchedule.repeatUntil ? new Date(baseSchedule.repeatUntil) : new Date(startDate);
            endDate.setMonth(endDate.getMonth() + 3); // Default 3 months if not specified

            let currentDate = new Date(startDate);
            let eventCount = 0;

            while (currentDate <= endDate && eventCount < 50) { // Limit to 50 occurrences
                if (baseSchedule.repeatType === 'weekly' && baseSchedule.repeatDays) {
                    baseSchedule.repeatDays.forEach(day => {
                        const dayNum = parseInt(day);
                        const tempDate = new Date(currentDate);
                        const daysToAdd = (dayNum - tempDate.getDay() + 7) % 7;
                        tempDate.setDate(tempDate.getDate() + daysToAdd);
                        
                        if (tempDate >= startDate && tempDate <= endDate) {
                            schedules.push({
                                ...baseSchedule,
                                id: baseSchedule.id + '-' + Date.now() + eventCount++,
                                date: tempDate.toISOString().split('T')[0],
                                repeat: false
                            });
                        }
                    });
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (baseSchedule.repeatType === 'biweekly') {
                    schedules.push({
                        ...baseSchedule,
                        id: baseSchedule.id + '-' + Date.now() + eventCount++,
                        date: currentDate.toISOString().split('T')[0],
                        repeat: false
                    });
                    currentDate.setDate(currentDate.getDate() + 14);
                } else if (baseSchedule.repeatType === 'monthly') {
                    schedules.push({
                        ...baseSchedule,
                        id: baseSchedule.id + '-' + Date.now() + eventCount++,
                        date: currentDate.toISOString().split('T')[0],
                        repeat: false
                    });
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }
        }

        function setColor(color) {
            document.getElementById('colorInput').value = color;
            
            // Update color preset buttons to show selected state
            document.querySelectorAll('.color-preset').forEach(btn => {
                btn.style.border = 'none';
                btn.style.transform = 'scale(1)';
            });
            
            event.target.style.border = '3px solid white';
            event.target.style.transform = 'scale(1.1)';
            
            // Save to recent colors
            saveRecentColor(color);
        }
        
        // Recent colors management
        function saveRecentColor(color) {
            let recentColors = JSON.parse(localStorage.getItem('recentColors') || '[]');
            
            // Remove if already exists
            recentColors = recentColors.filter(c => c !== color);
            
            // Add to beginning
            recentColors.unshift(color);
            
            // Keep only last 8 colors
            recentColors = recentColors.slice(0, 8);
            
            localStorage.setItem('recentColors', JSON.stringify(recentColors));
            updateRecentColors();
        }
        
        function updateRecentColors() {
            const recentColors = JSON.parse(localStorage.getItem('recentColors') || '[]');
            const container = document.getElementById('recentColorsList');
            
            if (recentColors.length === 0) {
                document.getElementById('recentColors').style.display = 'none';
                return;
            }
            
            document.getElementById('recentColors').style.display = 'block';
            container.innerHTML = recentColors.map(color => 
                `<button type="button" class="color-preset" style="width: 35px; height: 35px; border: none; border-radius: 8px; background: ${color}; cursor: pointer;" onclick="setColor('${color}')"></button>`
            ).join('');
        }
        
        // Calendar Day view improvements
        function changeView(viewName) {
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const viewMap = {
                'month': 'dayGridMonth',
                'week': 'timeGridWeek',
                'day': 'timeGridDay',
                'list': 'listMonth'  // Changed to listMonth to show all events
            };
            
            calendar.changeView(viewMap[viewName]);
        }

        function showEventModal(event) {
            currentEvent = event;
            document.getElementById('modalTitle').textContent = event.title;
            
            const props = event.extendedProps;
            let timeDisplay = props.allDay ? 'All Day' : `${props.startTime} - ${props.endTime}`;
            
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Type:</strong> ${props.type.charAt(0).toUpperCase() + props.type.slice(1)}</p>
                <p><strong>Date:</strong> ${new Date(props.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p><strong>Time:</strong> ${timeDisplay}</p>
                ${props.repeat ? `<p><strong>Recurring:</strong> ${props.repeatType}</p>` : ''}
            `;
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            currentEvent = null;
        }

        function editEvent() {
            if (!currentEvent) return;
            
            const schedule = schedules.find(s => s.id === currentEvent.id);
            if (!schedule) return;
            
            // Set editing mode
            editingEventId = schedule.id;
            
            // Fill form with event data
            document.querySelector(`input[name="type"][value="${schedule.type}"]`).checked = true;
            handleTypeChange(); // Update form based on type
            
            document.getElementById('title').value = schedule.title;
            document.getElementById('date').value = schedule.date;
            
            if (schedule.allDay) {
                document.getElementById('allDay').checked = true;
                toggleTimeInputs();
            } else {
                document.getElementById('startTime').value = schedule.startTime;
                document.getElementById('endTime').value = schedule.endTime;
            }
            
            if (schedule.color) {
                document.getElementById('color').value = schedule.color;
            }
            
            // Scroll to form
            document.querySelector('.schedule-form-container').scrollIntoView({ behavior: 'smooth' });
            
            // Close modal
            closeEventModal();
        }

        async function deleteEvent() {
            if (!currentEvent) return;
            
            const eventId = currentEvent.id;
            const event = schedules.find(s => s.id === eventId);
            
            if (!event) return;
            
            // Î∞òÎ≥µ ÏùºÏ†ïÏù∏ÏßÄ ÌôïÏù∏
            if (event.repeat || event.repeatType) {
                const choice = confirm('Ïù¥Í≤ÉÏùÄ Î∞òÎ≥µ ÏùºÏ†ïÏûÖÎãàÎã§.\n\nÎ™®Îì† Î∞òÎ≥µ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÎ†§Î©¥ "ÌôïÏù∏"ÏùÑ,\nÏù¥ ÏùºÏ†ïÎßå ÏÇ≠Ï†úÌïòÎ†§Î©¥ "Ï∑®ÏÜå"Î•º ÎàÑÎ•¥ÏÑ∏Ïöî.');
                
                if (choice) {
                    // Î™®Îì† Î∞òÎ≥µ ÏùºÏ†ï ÏÇ≠Ï†ú
                    const baseId = eventId.split('-')[0];
                    const relatedEvents = schedules.filter(s => 
                        s.id.startsWith(baseId) || 
                        (s.title === event.title && s.repeatType === event.repeatType)
                    );
                    
                    if (relatedEvents.length > 1) {
                        if (!confirm(`Ï¥ù ${relatedEvents.length}Í∞úÏùò Î∞òÎ≥µ ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                            return;
                        }
                    }
                    
                    // ÏÑúÎ≤ÑÏóêÏÑú Î™®Îì† Í¥ÄÎ†® ÏùºÏ†ï ÏÇ≠Ï†ú
                    for (const relatedEvent of relatedEvents) {
                        try {
                            await API.studyPlans.delete(relatedEvent.id);
                        } catch (error) {
                            console.error(`Failed to delete event ${relatedEvent.id}:`, error);
                        }
                    }
                } else {
                    // Îã®Ïùº ÏùºÏ†ïÎßå ÏÇ≠Ï†ú
                    try {
                        await API.studyPlans.delete(eventId);
                    } catch (error) {
                        console.error('Failed to delete event:', error);
                        alert('ÏùºÏ†ï ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                        return;
                    }
                }
            } else {
                // Îã®Ïùº ÏùºÏ†ï ÏÇ≠Ï†ú
                if (!confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                
                try {
                    await API.studyPlans.delete(eventId);
                } catch (error) {
                    console.error('Failed to delete event:', error);
                    alert('ÏùºÏ†ï ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    return;
                }
            }
            
            // ÏÑ±Í≥µ Ïãú Î°úÏª¨ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ï∫òÎ¶∞Îçî ÏÉàÎ°úÍ≥†Ïπ®
            await loadSchedules();
            closeEventModal();
        }

        async function updateEventDateTime(event) {
            const schedule = schedules.find(s => s.id === event.id);
            if (!schedule) return;
            
            const newDate = event.start.toISOString().split('T')[0];
            const newStartTime = event.start.toTimeString().substr(0, 5);
            const newEndTime = event.end ? event.end.toTimeString().substr(0, 5) : schedule.endTime;
            
            // ÏÑúÎ≤ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
            const updateRequest = {
                title: schedule.title,
                type: schedule.type,
                date: newDate,
                startTime: schedule.allDay ? null : newStartTime,
                endTime: schedule.allDay ? null : newEndTime,
                allDay: schedule.allDay,
                color: schedule.color,
                repeat: false, // ÎìúÎûòÍ∑∏Ìïú ÏùºÏ†ïÏùÄ Î∞òÎ≥µ Ìï¥Ï†ú
                className: schedule.className,
                description: schedule.description
            };
            
            try {
                await API.studyPlans.update(event.id, updateRequest);
                
                // ÏÑ±Í≥µ Ïãú Î°úÏª¨ ÏóÖÎç∞Ïù¥Ìä∏
                schedule.date = newDate;
                schedule.startTime = newStartTime;
                schedule.endTime = newEndTime;
                
                saveSchedules();
            } catch (error) {
                console.error('Failed to update event:', error);
                alert('ÏùºÏ†ï ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                
                // Ïã§Ìå® Ïãú Ï∫òÎ¶∞Îçî ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú ÏõêÎûò ÏÉÅÌÉúÎ°ú Î≥µÍµ¨
                await loadSchedules();
                if (calendar) {
                    calendar.refetchEvents();
                }
            }
        }

        async function generateAIStudyPlan() {
            const resultDiv = document.getElementById('aiPlanResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> AIÍ∞Ä ÎãπÏã†Ïùò ÎßûÏ∂§Ìòï ÌïôÏäµ Í≥ÑÌöçÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>';

            try {
                // ÏàòÏóÖÍ≥º ÏãúÌóò ÏùºÏ†ï ÌïÑÌÑ∞ÎßÅ
                const classes = schedules.filter(s => s.type === 'class');
                const exams = schedules.filter(s => s.type === 'exam');
                
                if (classes.length === 0 && exams.length === 0) {
                    resultDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-calendar-times" style="font-size: 3em; color: #dee2e6; margin-bottom: 15px;"></i>
                            <h4>ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</h4>
                            <p>Î®ºÏ†Ä ÏàòÏóÖÏù¥ÎÇò ÏãúÌóò ÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.</p>
                        </div>
                    `;
                    return;
                }
                
                // Îç∞Ïù¥ÌÑ∞ ÌòïÏãù Ï†ïÎ¶¨
                const coursesData = classes.map(c => ({
                    title: c.title,
                    date: c.date,
                    time: c.allDay ? 'All Day' : `${c.startTime} - ${c.endTime}`,
                    repeat: c.repeat || false,
                    repeatType: c.repeatType || null
                }));
                
                const examsData = exams.map(e => ({
                    title: e.title,
                    date: e.date,
                    time: `${e.startTime} - ${e.endTime}`
                }));
                
                // AI API Ìò∏Ï∂ú
                const response = await API.ai.generateStudyPlan({
                    courses: coursesData,
                    exams: examsData
                });
                
                // ÎßàÌÅ¨Îã§Ïö¥ÏùÑ HTMLÎ°ú Î≥ÄÌôò
                const htmlContent = convertMarkdownToHtml(response);
                
                resultDiv.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                        ${htmlContent}
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="button" onclick="copyStudyPlan()">
                                <i class="fas fa-copy"></i> Î≥µÏÇ¨ÌïòÍ∏∞
                            </button>
                            <button class="button primary" onclick="applyStudyPlan()">
                                <i class="fas fa-calendar-plus"></i> Ï∫òÎ¶∞ÎçîÏóê Ï†ÅÏö©
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error generating study plan:', error);
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <h4>ÌïôÏäµ Í≥ÑÌöç ÏÉùÏÑ± Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="button" onclick="generateAIStudyPlan()" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Îã§Ïãú ÏãúÎèÑ
                        </button>
                    </div>
                `;
            }
        }
        
        // ÎßàÌÅ¨Îã§Ïö¥ÏùÑ HTMLÎ°ú Î≥ÄÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
        function convertMarkdownToHtml(markdown) {
            // Í∞ÑÎã®Ìïú ÎßàÌÅ¨Îã§Ïö¥ Î≥ÄÌôò (Ïã§Ï†úÎ°úÎäî marked.js Í∞ôÏùÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© Í∂åÏû•)
            let html = markdown
                // Ìó§Îçî Î≥ÄÌôò
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Î≥ºÎìúÏ≤¥ Î≥ÄÌôò
                .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                // Î¶¨Ïä§Ìä∏ Î≥ÄÌôò
                .replace(/^\* (.+)$/gim, '<li>$1</li>')
                .replace(/^- (.+)$/gim, '<li>$1</li>')
                .replace(/^\d+\. (.+)$/gim, '<li>$1</li>')
                // Ï§ÑÎ∞îÍøà Î≥ÄÌôò
                .replace(/\n\n/g, '</p><p>')
                // Ïù¥Î™®ÏßÄ Ïú†ÏßÄ
                .replace(/‚úÖ/g, '<span style="color: #4caf50;">‚úÖ</span>')
                .replace(/üìÖ/g, '<span style="font-size: 1.2em;">üìÖ</span>')
                .replace(/üéØ/g, '<span style="font-size: 1.2em;">üéØ</span>')
                .replace(/‚è∞/g, '<span style="font-size: 1.2em;">‚è∞</span>')
                .replace(/üìä/g, '<span style="font-size: 1.2em;">üìä</span>')
                .replace(/üîÑ/g, '<span style="font-size: 1.2em;">üîÑ</span>')
                .replace(/üìù/g, '<span style="font-size: 1.2em;">üìù</span>')
                .replace(/üí°/g, '<span style="font-size: 1.2em;">üí°</span>')
                .replace(/‚ö†Ô∏è/g, '<span style="color: #ff9800;">‚ö†Ô∏è</span>')
                .replace(/üìà/g, '<span style="font-size: 1.2em;">üìà</span>');
            
            // Î¶¨Ïä§Ìä∏ ÌÉúÍ∑∏ Í∞êÏã∏Í∏∞
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Îã®ÎùΩ ÌÉúÍ∑∏ Í∞êÏã∏Í∏∞
            if (!html.startsWith('<')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }
        
        // ÌïôÏäµ Í≥ÑÌöç Î≥µÏÇ¨ Ìï®Ïàò
        function copyStudyPlan() {
            const planContent = document.querySelector('#aiPlanResult .button').parentElement.parentElement.innerText;
            navigator.clipboard.writeText(planContent).then(() => {
                alert('ÌïôÏäµ Í≥ÑÌöçÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            }).catch(err => {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏÑ†ÌÉùÌïòÏó¨ Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.');
            });
        }
        
        // ÌïôÏäµ Í≥ÑÌöçÏùÑ Ï∫òÎ¶∞ÎçîÏóê Ï†ÅÏö©ÌïòÎäî Ìï®Ïàò
        function applyStudyPlan() {
            // ÌïôÏäµ Í≥ÑÌöçÏóêÏÑú Ï∂îÏ≤úÎêú ÏãúÍ∞ÑÎåÄÎ•º ÌååÏã±ÌïòÏó¨ Ï∫òÎ¶∞ÎçîÏóê Ï∂îÍ∞ÄÌïòÎäî Î°úÏßÅ
            // Ïù¥Îäî Îçî Î≥µÏû°Ìïú Íµ¨ÌòÑÏù¥ ÌïÑÏöîÌïòÎØÄÎ°ú ÏùºÎã® ÏïàÎÇ¥ Î©îÏãúÏßÄÎßå ÌëúÏãú
            alert('ÌïôÏäµ Í≥ÑÌöçÏùò Ï∂îÏ≤ú ÏãúÍ∞ÑÎåÄÎ•º Ï∞∏Í≥†ÌïòÏó¨ Ï∫òÎ¶∞ÎçîÏóê ÏßÅÏ†ë ÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
        }

        function logout() {
            API.auth.logout();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target == modal) {
                closeEventModal();
            }
        }
        
        // TODO Functions
        function loadTodos() {
            console.log('Loading TODOs...');
            const saved = localStorage.getItem('studiaTodos');
            if (saved) {
                try {
                    todos = JSON.parse(saved);
                    console.log('Loaded TODOs:', todos);
                    
                    // Remove existing TODO events from schedules first
                    schedules = schedules.filter(s => !s.isTodo);
                    
                    // Sync TODO calendar events (only uncompleted ones)
                    todos.forEach(todo => {
                        if (todo.dueDate && !todo.completed) {
                            // Add to schedules
                            const schedule = {
                                id: 'todo-' + todo.id,
                                type: 'study',
                                title: 'TODO: ' + todo.text,
                                date: todo.dueDate,
                                startTime: todo.dueTime || '09:00',
                                endTime: todo.dueTime ? 
                                    (parseInt(todo.dueTime.split(':')[0]) + 1).toString().padStart(2, '0') + ':00' : 
                                    '10:00',
                                allDay: !todo.dueTime,
                                color: todo.priority === 'high' ? '#f44336' : 
                                       todo.priority === 'medium' ? '#ff9800' : '#4caf50',
                                className: 'TODO List',
                                isTodo: true
                            };
                            schedules.push(schedule);
                        }
                    });
                    
                    // Save updated schedules
                    saveSchedules();
                    
                } catch (error) {
                    console.error('Error parsing TODOs:', error);
                    todos = [];
                }
            } else {
                todos = [];
                console.log('No TODOs found, starting fresh');
            }
            renderTodos();
        }
        
        function saveTodos() {
            localStorage.setItem('studiaTodos', JSON.stringify(todos));
        }
        
        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            if (!todoList) {
                console.error('TODO list element not found!');
                return;
            }
            
            if (!todos || todos.length === 0) {
                todoList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No tasks yet. Add your first study task!</p>';
                return;
            }
            
            try {
                // Sort todos by completion status, priority, and date
                const sortedTodos = [...todos].sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    // Priority order: high > medium > low > null
                    const priorityOrder = { high: 3, medium: 2, low: 1, null: 0 };
                    const aPriority = priorityOrder[a.priority] || 0;
                    const bPriority = priorityOrder[b.priority] || 0;
                    if (aPriority !== bPriority) {
                        return bPriority - aPriority;
                    }
                    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                });
                
                todoList.innerHTML = sortedTodos.map(todo => `
                    <div class="todo-item" data-id="${todo.id}">
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} 
                               onchange="toggleTodo('${todo.id}')">
                        <div style="flex: 1;">
                            <div class="todo-text ${todo.completed ? 'completed' : ''}">${escapeHtml(todo.text)}</div>
                            <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.85em; color: #666;">
                                ${todo.dueDate ? `<span><i class="fas fa-calendar"></i> ${new Date(todo.dueDate).toLocaleDateString()}</span>` : ''}
                                ${todo.dueTime ? `<span><i class="fas fa-clock"></i> ${todo.dueTime}</span>` : ''}
                                ${todo.notes ? `<span><i class="fas fa-sticky-note"></i> Notes</span>` : ''}
                            </div>
                        </div>
                        ${todo.priority ? `<span class="todo-priority priority-${todo.priority}">${todo.priority.charAt(0).toUpperCase() + todo.priority.slice(1)}</span>` : ''}
                        <div class="todo-actions">
                            <button class="todo-edit-btn" onclick="editTodo('${todo.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="todo-delete-btn" onclick="deleteTodo('${todo.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                console.log('TODOs rendered successfully');
            } catch (error) {
                console.error('Error rendering TODOs:', error);
                todoList.innerHTML = '<p style="text-align: center; color: #f44336; padding: 20px;">Error displaying tasks. Please refresh the page.</p>';
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a task');
                return;
            }
            
            // Show todo details modal
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0;">Add Task Details</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Task:</label>
                            <input type="text" id="todoText" value="${text}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Priority:</label>
                            <select id="todoPriority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">No Priority</option>
                                <option value="high">High Priority</option>
                                <option value="medium">Medium Priority</option>
                                <option value="low">Low Priority</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Due Date (Optional):</label>
                            <input type="date" id="todoDueDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Time (Optional):</label>
                            <input type="time" id="todoDueTime" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Notes (Optional):</label>
                            <textarea id="todoNotes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">Cancel</button>
                            <button onclick="saveTodoWithDetails()" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer;">Save Task</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store modal reference for saving
            window.currentTodoModal = modal;
        }
        
        function saveTodoWithDetails() {
            const text = document.getElementById('todoText').value.trim();
            const priority = document.getElementById('todoPriority').value;
            const dueDate = document.getElementById('todoDueDate').value;
            const dueTime = document.getElementById('todoDueTime').value;
            const notes = document.getElementById('todoNotes').value.trim();
            
            if (!text) {
                alert('Task description is required');
                return;
            }
            
            const todo = {
                id: Date.now().toString(),
                text: text,
                completed: false,
                createdAt: new Date().toISOString(),
                priority: priority || null,
                dueDate: dueDate || null,
                dueTime: dueTime || null,
                notes: notes || null
            };
            
            todos.push(todo);
            saveTodos();
            renderTodos();
            
            // Clear input
            document.getElementById('todoInput').value = '';
            
            // Close modal
            if (window.currentTodoModal) {
                window.currentTodoModal.remove();
                window.currentTodoModal = null;
            }
            
            // Automatically add to calendar if due date is set
            if (dueDate) {
                addTodoToCalendar(todo);
                showNotification('Task added to calendar!');
            }
        }
        
        // Notification function for TODO
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                todo.completedAt = todo.completed ? new Date().toISOString() : null;
                saveTodos();
                renderTodos();
                
                // Update calendar visibility
                const todoScheduleId = 'todo-' + id;
                if (todo.completed) {
                    // Remove from calendar when completed
                    schedules = schedules.filter(s => s.id !== todoScheduleId);
                    saveSchedules();
                } else if (todo.dueDate) {
                    // Add back to calendar when uncompleted
                    addTodoToCalendar(todo);
                }
            }
        }
        
        function editTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            const newText = prompt('Edit task:', todo.text);
            if (newText && newText.trim()) {
                todo.text = newText.trim();
                todo.updatedAt = new Date().toISOString();
                saveTodos();
                renderTodos();
                
                // Update calendar event if it exists
                const todoScheduleId = 'todo-' + id;
                const schedule = schedules.find(s => s.id === todoScheduleId);
                if (schedule) {
                    schedule.title = 'TODO: ' + todo.text;
                    saveSchedules();
                }
            }
        }
        
        function deleteTodo(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                todos = todos.filter(t => t.id !== id);
                saveTodos();
                
                // Remove from schedules and calendar
                const todoScheduleId = 'todo-' + id;
                schedules = schedules.filter(s => s.id !== todoScheduleId);
                saveSchedules();
                
                // Remove from calendar immediately
                if (calendar) {
                    const event = calendar.getEventById(todoScheduleId);
                    if (event) {
                        event.remove();
                    }
                }
                
                renderTodos();
            }
        }
        
        function addTodoToCalendar(todo) {
            const dueDate = todo.dueDate || new Date().toISOString().split('T')[0];
            const todoScheduleId = 'todo-' + todo.id;
            
            // Check if already exists
            const existingSchedule = schedules.find(s => s.id === todoScheduleId);
            if (existingSchedule) {
                console.log('TODO already in calendar:', todoScheduleId);
                return;
            }
            
            const schedule = {
                id: todoScheduleId,
                type: 'study',
                title: 'TODO: ' + todo.text,
                date: dueDate,
                startTime: todo.dueTime || '09:00',
                endTime: todo.dueTime ? 
                    (parseInt(todo.dueTime.split(':')[0]) + 1).toString().padStart(2, '0') + ':00' : 
                    '10:00',
                allDay: !todo.dueTime,
                color: todo.priority === 'high' ? '#f44336' : 
                       todo.priority === 'medium' ? '#ff9800' : '#4caf50',
                className: 'TODO List',
                isTodo: true
            };
            
            // Î°úÏª¨ Ïä§ÏºÄÏ§ÑÏóê Ï∂îÍ∞Ä
            schedules.push(schedule);
            saveSchedules();
        }
        
        // Add Enter key support for TODO input
        document.addEventListener('DOMContentLoaded', function() {
            const todoInput = document.getElementById('todoInput');
            if (todoInput) {
                todoInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTodo();
                    }
                });
            }
        });
    </script>
</body>
</html>
